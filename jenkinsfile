pipeline {
    agent any
    environment {
        // ID reference for Git and SSH credentials
        GIT_CREDENTIALS_ID = 'github'
        SSH_CREDENTIALS_ID = 'ssh'
    }
    stages {
        stage('Checkout') {
            steps {
                // Using Git credentials to check out the repo
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']], 
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    submoduleCfg: [],
                    userRemoteConfigs: [
                        [
                            credentialsId: "${env.GIT_CREDENTIALS_ID}",
                            url: 'https://github.com/lizbabz/JavaCalculator.git'
                        ]
                    ]
                ])
            }
        }
        
        stage('Build') {
            steps {
                // Build the project using Maven in batch mode
                sh 'mvn -B clean package'
            }
        }
        
        stage('Deploy') {
            steps {
                // Use the sshagent to provide SSH credentials for Ansible
                sshagent([env.SSH_CREDENTIALS_ID]) {
                    // Running the Ansible playbook
                    sh 'ansible-playbook -vvv webservers.yml -i hosts.ini -e ansible_python_interpreter=/usr/bin/python3'
                }
            }
        }
        
        stage('Post-Deployment Check') {
            steps {
                script {
                    // Define a list of server IPs and check if the application is accessible
                    def serverUrls = ['http://18.191.173.23:8080/WebAppCal-0.0.6/', 'http://3.137.156.79:8080/WebAppCal-0.0.6/', 'http://18.216.175.230:8080/WebAppCal-0.0.6/']
                    serverUrls.each { url ->
                        echo "Checking application status at URL: ${url}"
                        def responseCode = sh(script: "curl -s -o /dev/null -w '%{http_code}' ${url}", returnStdout: true).trim()
                        if (responseCode != '200') {
                            error "Failed to access the web application at URL: ${url}, response code: ${responseCode}"
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment succeeded!'
        }
        failure {
            echo 'Deployment failed.'
        }
    }
}
